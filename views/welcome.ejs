<!DOCTYPE html>
<html>
<head>
  <title>Welcome</title>
  <link rel="stylesheet" href="/css/girly.css">
</head>
<body>
  <!-- Banner: image only (no text overlay) -->
  <div class="banner-hero">
    <img src="/img/background.jpg" alt="Banner group photo">
  </div>

  <div class="container">
    <!-- Header under the banner -->
    <div class="header">
      <div>
        <div class="title">Welcome, <%= user.name %> ‚ú®</div>
        <div class="subtitle">Your Safety Keeper üíï Always here for you.</div>
      </div>
      <div class="badge">Area: <%= user.area %></div>
    </div>

    <!-- Danger Zone banner (auto-fetched) -->
    <div id="dangerBanner"></div>

    <div class="grid">
      <!-- Submit Anonymous Report -->
      <div class="col-4">
        <div class="card">
          <img src="/img/submit-anonymous-report.avif" alt="Submit report">
          <div class="card-body">
            <h3>Submit Anonymous Report</h3>
            <p>Share any incident you witnessed or faced. Your identity stays private.</p>
            <div class="actions">
              <a class="btn btn-primary w-100" href="/report">Report Now</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports in My Area -->
      <div class="col-4">
        <div class="card">
          <img src="/img/reports-in-my-area.jpg" alt="Reports in area">
          <div class="card-body">
            <h3>Reports in My Area</h3>
            <p>See what‚Äôs been reported recently around <strong><%= user.area %></strong>.</p>
            <div class="actions">
              <a class="btn btn-secondary w-100" href="/my-area-reports">View Reports</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Safety Check Timer -->
      <div class="col-4">
        <div class="card">
          <img src="/img/safety-check-timer.jpg" alt="Safety check timer">
          <div class="card-body">
            <h3>Safety Check Timer</h3>
            <p>Set a timer to confirm you‚Äôre safe. We‚Äôll alert your contact if you miss it.</p>
            <div class="actions">
              <a class="btn btn-secondary w-100" href="/checkins">Open Timer</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Safe Check-in Points -->
      <div class="col-4">
        <div class="card">
          <img src="/img/safe-checkin-points.webp" alt="Safe check-in points">
          <div class="card-body">
            <h3>Safe Check-in Points</h3>
            <p>Find nearby police stations and hospitals to head to if you need help.</p>
            <div class="actions">
              <a class="btn btn-secondary w-100" href="/places">View Map</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Safe Route Finder -->
      <div class="col-4">
        <div class="card">
          <img src="/img/safe-route-finder.webp" alt="Safe route finder">
          <div class="card-body">
            <h3>Safe Route Finder</h3>
            <p>Pick safer paths and avoid hot zones while traveling in Dhaka.</p>
            <div class="actions">
              <a class="btn btn-secondary w-100" href="/safe-route">Find Route</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Volunteer Network -->
      <div class="col-4">
        <div class="card">
          <img src="/img/volunteer-network.avif" alt="Volunteer network">
          <div class="card-body">
            <h3>Volunteer Network</h3>
            <p>Verified helpers in your area who can check on you or offer guidance.</p>
            <div class="actions">
              <a class="btn btn-secondary w-100" href="/volunteers">Explore Volunteers</a>
            </div>
          </div>
        </div>
      </div>

      <!-- One-Click SOS -->
      <div class="col-4">
        <div class="card">
          <img src="/img/one-click-sos.jpg" alt="SOS character">
          <div class="card-body">
            <h3>One-Click SOS</h3>
            <p>Instantly alert your emergency contact and nearby volunteers.</p>
            <div class="actions">
              <button id="sosBtn" class="btn btn-sos w-100" type="button">Send SOS Now</button>
            </div>
          </div>
        </div>
      </div>

      <% if (user && user.email === 'admin@evesafe.com') { %>
      <!-- Admin -->
      <div class="col-4">
        <div class="card">
          <img src="/img/reports-in-my-area.jpg" alt="Admin analytics">
          <div class="card-body">
            <h3>Admin: All Reports</h3>
            <p>Moderate and manage reports from all areas.</p>
            <div class="actions">
              <a class="btn btn-outline w-100" href="/admin/reports">Open Admin</a>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Tiny floating toggle to enable background Voice SOS once -->
  <style>
    #voiceToggle {
      position: fixed; right: 18px; bottom: 84px; z-index: 9999;
      background:#ffe8f3; color:#b4005e; border:1px solid #ffc5dd;
      padding:10px 12px; border-radius:999px; font-weight:700; font-size:13px;
      box-shadow: 0 6px 18px rgba(255,104,164,.15); cursor:pointer;
    }
    #voiceToggle.active{ background:#ff5fa2; color:#fff; border-color:#ff5fa2; }
  </style>
  <div id="voiceToggle" title="Enable background voice SOS">Enable Voice SOS</div>

  <script>
    /* ------------------ CLICK SOS (kept) ------------------ */
    async function postSOS() {
      try {
        const res = await fetch('/sos?t=' + Date.now(), {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });
        if (!res.ok) {
          if (res.status === 401) alert('Your session expired. Please log in again.');
          console.warn('SOS HTTP', res.status);
          return;
        }
        const js = await res.json();
        if (js.ok) console.log('‚úÖ SOS sent @', new Date(js.ts).toLocaleTimeString(), js);
        else console.warn('SOS responded not ok:', js);
      } catch (e) {
        console.error('‚ùå SOS network error:', e);
      }
    }

    let sosInFlight=false,lastSOS=0;
    async function sendSOS(){
      // small UI debounce for button only (doesn't limit voice)
      const now=Date.now(); if(sosInFlight||now-lastSOS<2000) return;
      sosInFlight=true; const btn=document.getElementById('sosBtn'); const old=btn.innerText;
      btn.disabled=true; btn.innerText='Sending...';
      try{ await postSOS(); lastSOS=now; btn.innerText='SOS Sent';
           setTimeout(()=>{btn.innerText=old;btn.disabled=false;},1200); }
      catch{ btn.innerText='Failed ‚Äî try again';
             setTimeout(()=>{btn.innerText=old;btn.disabled=false;},1500); }
      finally{ sosInFlight=false; }
    }
    document.getElementById('sosBtn')?.addEventListener('click',sendSOS);

    /* ------------------ DANGER BANNER ------------------ */
    (function(){
      const area = <%- JSON.stringify(user.area) %>;
      fetch('/danger/area?name='+encodeURIComponent(area))
        .then(r=>r.json()).then(r=>{
          if(!r||!r.level) return;
          if(r.level==='high'||r.level==='moderate'){
            const el=document.getElementById('dangerBanner');
            const txt = r.level==='high'
              ? `‚ö†Ô∏è High risk in ${r.area}. Reports: ${r.recentReports}. Avg rating: ${r.avgRating}/5. Stay alert.`
              : `‚ö†Ô∏è Moderate risk in ${r.area}. Reports: ${r.recentReports}. Avg rating: ${r.avgRating}/5.`;
            el.textContent=txt; el.style.display='block';
          }
        }).catch(()=>{});
    })();

    /* ------------------ VOICE SOS (enable once, works repeatedly) ------------------ */
    const KEYWORDS = ['help','sos','save me','bachao','bacao','bachan','danger'];
    let recognizer, listening=false;

    function startRecognizer() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { console.warn('SpeechRecognition not supported'); return; }

      // stop old
      if (recognizer) { try { recognizer.stop(); } catch {} }

      recognizer = new SR();
      recognizer.lang = 'en-US';         // add a 2nd recognizer for 'bn-BD' if you want Bangla
      recognizer.continuous = true;
      recognizer.interimResults = true;  // also react to interim to be more responsive

      recognizer.onresult = (e) => {
        let phrase = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const text = e.results[i][0].transcript;
          phrase += ' ' + text;
        }
        phrase = phrase.toLowerCase().trim();
        console.log('[voice]', phrase);
        if (KEYWORDS.some(k => phrase.includes(k))) {
          console.log('[voice] keyword matched ‚Äî sending SOS');
          postSOS(); // no cooldown here so it can fire again later
        }
      };

      recognizer.onerror = (ev) => {
        console.warn('[voice] error:', ev.error);
      };

      recognizer.onend = () => {
        if (listening) {
          console.log('[voice] restarting‚Ä¶');
          setTimeout(() => { try { recognizer.start(); } catch {} }, 400);
        }
      };

      try { recognizer.start(); listening = true; console.log('[voice] started'); } catch (e) {
        console.warn('[voice] start failed:', e.message);
      }
    }

    // sticky across visibility changes
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && localStorage.getItem('voiceSOSEnabled')==='1') {
        startRecognizer();
      }
    });

    // Enable/disable toggle (tiny floating pill)
    const voiceToggle = document.getElementById('voiceToggle');
    function setToggleUI(active){
      voiceToggle.textContent = active ? 'Voice SOS: ON' : 'Enable Voice SOS';
      voiceToggle.classList.toggle('active', active);
    }
    function enableVoice(){ localStorage.setItem('voiceSOSEnabled','1'); setToggleUI(true); startRecognizer(); }
    function disableVoice(){ localStorage.removeItem('voiceSOSEnabled'); setToggleUI(false); listening=false; try{recognizer&&recognizer.stop();}catch{} }

    voiceToggle.addEventListener('click', ()=>{
      if (localStorage.getItem('voiceSOSEnabled')==='1') disableVoice();
      else enableVoice();
    });

    // Auto-resume if previously enabled
    if (localStorage.getItem('voiceSOSEnabled')==='1'){ setToggleUI(true); setTimeout(startRecognizer, 300); }
    else { setToggleUI(false); }

    // Keyboard fallback: triple-press "S" in 2s
    let sCount=0, sTimer=null;
    window.addEventListener('keydown',(e)=>{
      if(e.key.toLowerCase()!=='s') return;
      sCount++; if(sCount===1) sTimer=setTimeout(()=>{sCount=0;},2000);
      if(sCount>=3){ clearTimeout(sTimer); sCount=0; postSOS(); }
    });
  </script>
</body>
</html>
